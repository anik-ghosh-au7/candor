{"version":3,"sources":["../../src/controller/chat.controller.js"],"names":["formatMessage","username","text","time","format","toString","botName","authenticateToken","token","res","redirect","jwt","verify","process","env","jwt_key","err","user","status","send","msg","name","webSocket","server","io","on","socket","clientId","handshake","headers","split","room","console","log","dbInterface","userJoin","join","getChatHistory","result","emit","broadcast","to","getRoomUsers","users","full_msg","saveChatHistory","userLeave","module","exports"],"mappings":"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","sourcesContent":["import ioLib from 'socket.io';\nimport jwt from 'jsonwebtoken';\nimport moment from 'moment';\nimport dbInterface from './chat.db.interface';\n\nfunction formatMessage(username, text) {\n    return {\n        username,\n        text,\n        time: moment().format('h:mm=ss:S= a DD-MM-yy').toString()\n    };\n}\n\nconst botName = 'Candor Admin';\n\nconst authenticateToken = (token) => {\n    let username;\n    if (!token) {\n        return res.redirect('/users/loginPage');\n    }\n    jwt.verify(token, process.env.jwt_key, (err, user) => {\n        if (err) return res.status(403).send({msg: 'Unauthorized Forbidden'});\n        username = user.name;\n        // return user.name;\n    });\n    return username;\n};\n\nconst webSocket = (server) => {\n    const io = ioLib(server);\n    io.on('connection', socket => {\n        let clientId = socket.handshake.headers['x-clientid'];\n        let username = authenticateToken(clientId.split('=')[1]);\n        let room = socket.handshake.headers['room'];\n        console.log('new socket connection established', username);\n        socket.on('joinRoom', async () => {\n            await dbInterface.userJoin(username, room);\n            socket.join(room);\n            //Loads chat history\n            // socket.emit('load_messages',await dbInterface.getChatHistory(room));\n\n            let result = await dbInterface.getChatHistory(room);\n            socket.emit('load_messages',result);\n\n            // Welcome current user\n            socket.emit('message', formatMessage(botName, 'Welcome to Candor!'));\n\n            // Broadcast when a user connects\n            socket.broadcast\n                .to(room)\n                .emit(\n                    'message',\n                    formatMessage(botName, `${username} has joined the chat`)\n                );\n\n            // Send users and room info\n            io.to(room).emit('roomUsers', {\n                room: room,\n                users: await dbInterface.getRoomUsers(room)\n            });\n            console.log('AFTER roomUsers');\n        });\n\n        // Listen for chatMessage\n        socket.on('chatMessage',async (msg) => {\n            let full_msg = formatMessage(username, msg);\n            await dbInterface.saveChatHistory(room, username, full_msg.text, full_msg.time);\n            io.to(room).emit('message', formatMessage(username, msg));\n        });\n\n        // Runs when client disconnects\n        socket.on('disconnect',async () => {\n            const user = await dbInterface.userLeave(username, room);\n\n            io.to(room).emit(\n                'message',\n                formatMessage(botName, `${username} has left the chat`)\n            );\n\n            // Send users and room info\n            io.to(room).emit('roomUsers', {\n                room: room,\n                users: await dbInterface.getRoomUsers(room)\n            });\n\n        });\n    });\n};\n\n\nmodule.exports = webSocket;\n"],"file":"chat.controller.js"}
{"version":3,"sources":["../../src/controller/chat.controller.js"],"names":["users","userJoin","username","room","user","push","userLeave","index","findIndex","splice","getRoomUsers","filter","formatMessage","text","time","format","botName","authenticateToken","token","res","redirect","jwt","verify","process","env","jwt_key","err","status","send","msg","console","log","name","webSocket","server","io","on","socket","clientId","handshake","headers","split","join","emit","broadcast","to","module","exports"],"mappings":";;;;AAAA;;AACA;;AACA;;AACA,IAAMA,KAAK,GAAG,EAAd,C,CAEA;;AACA,SAASC,QAAT,CAAmBC,QAAnB,EAA6BC,IAA7B,EAAmC;AACjC,MAAMC,IAAI,GAAG;AAAEF,IAAAA,QAAQ,EAARA,QAAF;AAAYC,IAAAA,IAAI,EAAJA;AAAZ,GAAb;AAEAH,EAAAA,KAAK,CAACK,IAAN,CAAWD,IAAX;AACD,C,CAED;;;AACA,SAASE,SAAT,CAAmBJ,QAAnB,EAA6B;AAC3B,MAAMK,KAAK,GAAGP,KAAK,CAACQ,SAAN,CAAgB,UAAAJ,IAAI;AAAA,WAAIA,IAAI,CAACF,QAAL,KAAkBA,QAAtB;AAAA,GAApB,CAAd;;AAEA,MAAIK,KAAK,KAAK,CAAC,CAAf,EAAkB;AAChB,WAAOP,KAAK,CAACS,MAAN,CAAaF,KAAb,EAAoB,CAApB,EAAuB,CAAvB,CAAP;AACD;AACF,C,CAED;;;AACA,SAASG,YAAT,CAAsBP,IAAtB,EAA4B;AAC1B,SAAOH,KAAK,CAACW,MAAN,CAAa,UAAAP,IAAI;AAAA,WAAIA,IAAI,CAACD,IAAL,KAAcA,IAAlB;AAAA,GAAjB,CAAP;AACD;;AAED,SAASS,aAAT,CAAuBV,QAAvB,EAAiCW,IAAjC,EAAuC;AACnC,SAAO;AACHX,IAAAA,QAAQ,EAARA,QADG;AAEHW,IAAAA,IAAI,EAAJA,IAFG;AAGHC,IAAAA,IAAI,EAAE,0BAASC,MAAT,CAAgB,QAAhB;AAHH,GAAP;AAKH;;AAED,IAAMC,OAAO,GAAG,cAAhB;;AAEA,IAAMC,iBAAiB,GAAG,SAApBA,iBAAoB,CAACC,KAAD,EAAW;AACjC,MAAIhB,QAAJ;;AACA,MAAI,CAACgB,KAAL,EAAY;AACR,WAAOC,GAAG,CAACC,QAAJ,CAAa,kBAAb,CAAP;AACH;;AACDC,2BAAIC,MAAJ,CAAWJ,KAAX,EAAkBK,OAAO,CAACC,GAAR,CAAYC,OAA9B,EAAuC,UAACC,GAAD,EAAMtB,IAAN,EAAe;AAClD,QAAIsB,GAAJ,EAAS,OAAOP,GAAG,CAACQ,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACC,MAAAA,GAAG,EAAE;AAAN,KAArB,CAAP;AACTC,IAAAA,OAAO,CAACC,GAAR,CAAY3B,IAAZ;AACAF,IAAAA,QAAQ,GAACE,IAAI,CAAC4B,IAAd,CAHkD,CAIlD;AACH,GALD;;AAMA,SAAO9B,QAAP;AACH,CAZD;;AAcA,IAAM+B,SAAS,GAAG,SAAZA,SAAY,CAACC,MAAD,EAAY;AAC1B,MAAMC,EAAE,GAAG,wBAAMD,MAAN,CAAX,CAD0B,CAE1B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACAC,EAAAA,EAAE,CAACC,EAAH,CAAM,YAAN,EAAoB,UAAAC,MAAM,EAAI;AAC1B,QAAIC,QAAQ,GAAGD,MAAM,CAACE,SAAP,CAAiBC,OAAjB,CAAyB,YAAzB,CAAf;AACA,QAAItC,QAAQ,GAAGe,iBAAiB,CAACqB,QAAQ,CAACG,KAAT,CAAe,GAAf,EAAoB,CAApB,CAAD,CAAhC;AACA,QAAItC,IAAI,GAAGkC,MAAM,CAACE,SAAP,CAAiBC,OAAjB,CAAyB,MAAzB,CAAX;AACAV,IAAAA,OAAO,CAACC,GAAR,CAAY,mCAAZ;AACAM,IAAAA,MAAM,CAACD,EAAP,CAAU,UAAV,EAAsB,YAAM;AACxBnC,MAAAA,QAAQ,CAACC,QAAD,EAAWC,IAAX,CAAR;AACAkC,MAAAA,MAAM,CAACK,IAAP,CAAYvC,IAAZ,EAFwB,CAGxB;;AACAkC,MAAAA,MAAM,CAACM,IAAP,CAAY,SAAZ,EAAuB/B,aAAa,CAACI,OAAD,EAAU,oBAAV,CAApC,EAJwB,CAMxB;;AACAqB,MAAAA,MAAM,CAACO,SAAP,CACKC,EADL,CACQ1C,IADR,EAEKwC,IAFL,CAGQ,SAHR,EAIQ/B,aAAa,CAACI,OAAD,YAAad,QAAb,0BAJrB,EAPwB,CAcxB;;AACAiC,MAAAA,EAAE,CAACU,EAAH,CAAM1C,IAAN,EAAYwC,IAAZ,CAAiB,WAAjB,EAA8B;AAC9BxC,QAAAA,IAAI,EAAEA,IADwB;AAE9BH,QAAAA,KAAK,EAAEU,YAAY,CAACP,IAAD;AAFW,OAA9B;AAIH,KAnBD,EAL0B,CA0B1B;;AACAkC,IAAAA,MAAM,CAACD,EAAP,CAAU,aAAV,EAAyB,UAAAP,GAAG,EAAI;AAC5BM,MAAAA,EAAE,CAACU,EAAH,CAAM1C,IAAN,EAAYwC,IAAZ,CAAiB,SAAjB,EAA4B/B,aAAa,CAACV,QAAD,EAAW2B,GAAX,CAAzC;AACH,KAFD,EA3B0B,CA+B1B;;AACAQ,IAAAA,MAAM,CAACD,EAAP,CAAU,YAAV,EAAwB,YAAM;AAC1B,UAAMhC,IAAI,GAAGE,SAAS,CAACJ,QAAD,CAAtB;;AAEA,UAAIE,IAAJ,EAAU;AACV+B,QAAAA,EAAE,CAACU,EAAH,CAAM1C,IAAN,EAAYwC,IAAZ,CACI,SADJ,EAEI/B,aAAa,CAACI,OAAD,YAAad,QAAb,wBAFjB,EADU,CAMV;;AACAiC,QAAAA,EAAE,CAACU,EAAH,CAAM1C,IAAN,EAAYwC,IAAZ,CAAiB,WAAjB,EAA8B;AAC1BxC,UAAAA,IAAI,EAAEA,IADoB;AAE1BH,UAAAA,KAAK,EAAEU,YAAY,CAACP,IAAD;AAFO,SAA9B;AAIC;AACJ,KAfD;AAgBH,GAhDD;AAiDH,CA3DD;;AA6DA2C,MAAM,CAACC,OAAP,GAAiBd,SAAjB","sourcesContent":["import ioLib from 'socket.io';\nimport jwt from 'jsonwebtoken';\nimport moment from 'moment';\nconst users = [];\n\n// Join user to chat\nfunction userJoin( username, room) {\n  const user = { username, room };\n\n  users.push(user);\n}\n\n// User leaves chat\nfunction userLeave(username) {\n  const index = users.findIndex(user => user.username === username);\n\n  if (index !== -1) {\n    return users.splice(index, 1)[0];\n  }\n}\n\n// Get room users\nfunction getRoomUsers(room) {\n  return users.filter(user => user.room === room);\n}\n\nfunction formatMessage(username, text) {\n    return {\n        username,\n        text,\n        time: moment().format('h:mm a')\n    };\n}\n\nconst botName = 'Candor Admin';\n\nconst authenticateToken = (token) => {\n    let username;\n    if (!token) {\n        return res.redirect('/users/loginPage');\n    }\n    jwt.verify(token, process.env.jwt_key, (err, user) => {\n        if (err) return res.status(403).send({msg: 'Unauthorized Forbidden'});\n        console.log(user);\n        username=user.name;\n        // return user.name;\n    });\n    return username;\n};\n\nconst webSocket = (server) => {\n    const io = ioLib(server);\n    // io.use((socket, next) => {\n    //     let clientId = socket.handshake.headers['x-clientid'];\n    //     console.log('from io');\n    //     let username = authenticateToken(clientId.split('=')[1]);\n    //     let room = socket.handshake.headers['room'];\n    //     next()\n    // });\n    // Run when client connects\n    io.on('connection', socket => {\n        let clientId = socket.handshake.headers['x-clientid'];\n        let username = authenticateToken(clientId.split('=')[1]);\n        let room = socket.handshake.headers['room'];\n        console.log('new socket connection established');\n        socket.on('joinRoom', () => {\n            userJoin(username, room);\n            socket.join(room);\n            // Welcome current user\n            socket.emit('message', formatMessage(botName, 'Welcome to Candor!'));\n\n            // Broadcast when a user connects\n            socket.broadcast\n                .to(room)\n                .emit(\n                    'message',\n                    formatMessage(botName, `${username} has joined the chat`)\n                );\n\n            // Send users and room info\n            io.to(room).emit('roomUsers', {\n            room: room,\n            users: getRoomUsers(room)\n            });\n        });\n\n        // Listen for chatMessage\n        socket.on('chatMessage', msg => {\n            io.to(room).emit('message', formatMessage(username, msg));\n        });\n\n        // Runs when client disconnects\n        socket.on('disconnect', () => {\n            const user = userLeave(username);\n\n            if (user) {\n            io.to(room).emit(\n                'message',\n                formatMessage(botName, `${username} has left the chat`)\n            );\n\n            // Send users and room info\n            io.to(room).emit('roomUsers', {\n                room: room,\n                users: getRoomUsers(room)\n            });\n            }\n        });\n    });\n};\n\nmodule.exports = webSocket;\n"],"file":"chat.controller.js"}
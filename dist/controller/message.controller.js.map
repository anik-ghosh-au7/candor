{"version":3,"sources":["../../src/controller/message.controller.js"],"names":["message_controller","handle_messages","req","res","flag","User","findOneAndUpdate","username","body","share_username","sender","user","shared_url","context","msg_body","comments","then","result","console","log","payload","JSON","stringify","title","findOne","subscription","forEach","element","webpush","sendNotification","parse","err","error","reciever","status","send","handle_post_comment_messages","receiver","url","message","length","slice","getmsg","messages","name","received","received_messages","sent","sent_messages","render","module","exports"],"mappings":"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","sourcesContent":["import User from '../model/user.model';\nimport webpush from 'web-push';\n\nconst message_controller={\n    handle_messages: async function (req,res) {\n        let flag = false;\n        // console.log('body',req.body);\n        await User.findOneAndUpdate({username:req.body.share_username},{\n                    \"$push\": {\n                        \"received_messages\": {\n                            sender: req.body.user,\n                            shared_url: req.body.context,\n                            msg_body: req.body.comments\n                        }\n                    }\n                })\n                .then((result) => {\n                    if(result){\n                        console.log(\"receiver message saved\");\n                        // res.status(200).send('Message sent');\n                        // let message = req.body.comments.length < 30 ? req.body.comments : req.body.comments.slice(0, 29) + '...';\n                        let payload = JSON.stringify({ \n                        title: `New message from ${req.body.user}`,\n                        msg_body: req.body.comments\n                    });\n                    User.findOne({username: req.body.share_username}).then(result => {\n                        // console.log('sub_obj : ', JSON.parse(result.subscription));\n                        result.subscription.forEach(element => {\n                            webpush.sendNotification(JSON.parse(element), payload)\n                        });\n                    }).catch(err => console.error(err));\n                        flag = true;\n                    }else{\n                        // res.status(400).send(\"Username doesn't exist\");\n                        flag = false;\n                    }\n                })\n                .catch(err => console.log(err));\n\n            if (flag) {\n                User.findOneAndUpdate({username:req.body.user},{\n                    \"$push\": {\n                        \"sent_messages\": {\n                            reciever: req.body.share_username,\n                            shared_url: req.body.context,\n                            msg_body: req.body.comments\n                        }\n                    }\n                })\n                .then(() => {\n                    console.log('sender message saved');\n                    res.status(200).send('Message sent');\n                })\n                .catch(err => console.log(err));\n            } else {\n                res.status(400).send(\"Username doesn't exist\");\n            }\n    },\n\n    handle_post_comment_messages : function (receiver, sender, url, body, title) {\n        User.findOneAndUpdate({username:receiver},{\n                    \"$push\": {\n                        \"received_messages\": {\n                            sender: sender,\n                            shared_url: url,\n                            msg_body: body\n                        }\n                    }\n                })\n                .then((result) => {\n                    if(result){\n                        console.log(\"receiver message saved\");\n                        let message = body.length < 30 ? body : body.slice(0, 29) + '...';\n                        let payload = JSON.stringify({ \n                        title: title,\n                        msg_body: message\n                    });\n                    User.findOne({username: receiver}).then(result => {\n                        result.subscription.forEach(element => {\n                            webpush.sendNotification(JSON.parse(element), payload)\n                        });\n                        return;\n                    }).catch(err => console.error(err));\n                    }\n                })\n                .catch(err => console.log(err));\n            },\n\n    getmsg: function (req,res) {\n        let messages={};\n        User.findOne({username:req.user.name}).then((result)=>{\n            // console.log(result);\n            messages.received=result.received_messages;\n            messages.sent=result.sent_messages;\n            messages.username=req.user.name;\n            res.render('msg_inbox_outbox',{messages});\n        });\n            // res.render('msg_inbox_outbox',[{'sent':messages.sent},{'received':messages.received}]);\n\n    }\n};\nmodule.exports=message_controller;\n"],"file":"message.controller.js"}